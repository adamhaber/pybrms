---

title: pybrms 
keywords: fastai
sidebar: home_sidebar

summary: "a pythonic interface for R's brms"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>brms is a fantastic R package that allows users to fit many kinds of Bayesian regression models - linear models, GLMs, survival analysis, etc - all in a multilevel context. Models are concisely specified using R's formula syntax, and the corresponding Stan program and data are automatically generated.</p>
<p>pybrms aims to bring the ease-of-use of brms to python users; more sampling, less index-gymnastics and shape errors.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install">&#182;</a></h2><p>Install via pip:</p>
<p><code>pip install pybrms</code></p>
<p>This installs the python package along with its pythonic dependencies; when you first call <a href="/pybrms.html"><code>pybrms</code></a>, it'll install <code>brms</code> and its dependencies. Don't worry if you don't have R or brms installed - they will be installed in your current virtual environment.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Example">Example<a class="anchor-link" href="#Example">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's use pybrms to fit a poisson regression model, including an interaction term and by-patient varying intercept. <a href="/pybrms.html"><code>pybrms</code></a> can import all datasets that are included in <code>brms</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">epilepsy</span> <span class="o">=</span> <span class="n">pybrms</span><span class="o">.</span><span class="n">get_brms_data</span><span class="p">(</span><span class="s2">&quot;epilepsy&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fitting the model is as simple as it is in <code>brms</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pybrms</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;count ~ zAge + zBase * Trt + (1 | patient)&quot;</span><span class="p">,</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">epilepsy</span><span class="p">,</span> 
    <span class="n">family</span> <span class="o">=</span> <span class="s2">&quot;poisson&quot;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:pystan:COMPILING THE C++ CODE FOR MODEL anon_model_6f531b7e8a9bc73464e98930b52f4547 NOW.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The user can also specify a list of priors, a <code>family</code> argument (is it a gaussian regression, binomial, poisson, etc), and optional <code>pystan</code> arguments like the number of chains, samples, etc.</p>
<p>When sampling is completed, <a href="/#fit"><code>fit</code></a> returns a <code>pystan</code> <code>StanFit4Model</code> object. The generated stan code is also available:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_stanmodel</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>StanModel object &#39;anon_model_6f531b7e8a9bc73464e98930b52f4547&#39; coded as follows:
// generated with brms 2.10.5
functions {
}
data {
  int&lt;lower=1&gt; N;  // number of observations
  int Y[N];  // response variable
  int&lt;lower=1&gt; K;  // number of population-level effects
  matrix[N, K] X;  // population-level design matrix
  // data for group-level effects of ID 1
  int&lt;lower=1&gt; N_1;  // number of grouping levels
  int&lt;lower=1&gt; M_1;  // number of coefficients per level
  int&lt;lower=1&gt; J_1[N];  // grouping indicator per observation
  // group-level predictor values
  vector[N] Z_1_1;
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
  int Kc = K - 1;
  matrix[N, Kc] Xc;  // centered version of X without an intercept
  vector[Kc] means_X;  // column means of X before centering
  for (i in 2:K) {
    means_X[i - 1] = mean(X[, i]);
    Xc[, i - 1] = X[, i] - means_X[i - 1];
  }
}
parameters {
  vector[Kc] b;  // population-level effects
  // temporary intercept for centered predictors
  real Intercept;
  vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations
  // standardized group-level effects
  vector[N_1] z_1[M_1];
}
transformed parameters {
  // actual group-level effects
  vector[N_1] r_1_1 = (sd_1[1] * (z_1[1]));
}
model {
  // initialize linear predictor term
  vector[N] mu = Intercept + Xc * b;
  for (n in 1:N) {
    // add more terms to the linear predictor
    mu[n] += r_1_1[J_1[n]] * Z_1_1[n];
  }
  // priors including all constants
  target += student_t_lpdf(Intercept | 3, 1, 10);
  target += student_t_lpdf(sd_1 | 3, 0, 10)
    - 1 * student_t_lccdf(0 | 3, 0, 10);
  target += normal_lpdf(z_1[1] | 0, 1);
  // likelihood including all constants
  if (!prior_only) {
    target += poisson_log_lpmf(Y | mu);
  }
}
generated quantities {
  // actual population-level intercept
  real b_Intercept = Intercept - dot_product(means_X, b);
}

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-it-works">How it works<a class="anchor-link" href="#How-it-works">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Behind the scene, <a href="/pybrms.html"><code>pybrms</code></a> calls <code>brms</code> via <code>rpy2</code>, handling the python-to-R-objects transitions in both directions and making sure that Stan gets the dtypes it expects by parsing the model's data block.</p>
<p>More specifically, <a href="/pybrms.html"><code>pybrms</code></a> calls two <code>brms</code> functions: <code>make_stancode</code> and <code>make_standata</code>, which are used to generate the appropriate model code, design matrices, etc. These are then "pulled back" to python and fed into <code>pystan</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Adding-priors">Adding priors<a class="anchor-link" href="#Adding-priors">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By defaults, <code>brms</code> uses non- or weakly-informative priors on model parameters. You can specify more informative priors using the following syntax:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pybrms</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="s2">&quot;count ~ zAge + zBase * Trt + (1|patient) + (1|obs)&quot;</span><span class="p">,</span>
                                           <span class="n">data</span> <span class="o">=</span> <span class="n">epilepsy</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="s2">&quot;poisson&quot;</span><span class="p">,</span>
                                           <span class="n">priors</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;student_t(5,0,10)&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span>
                                                     <span class="p">(</span><span class="s2">&quot;cauchy(0,2)&quot;</span><span class="p">,</span> <span class="s2">&quot;sd&quot;</span><span class="p">)]</span>
                                          <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:pystan:COMPILING THE C++ CODE FOR MODEL anon_model_3b2730a3196dc4b804b959d98397ba09 NOW.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Priors are passed as a list of tuples that conform to <code>brms</code> <code>set_prior</code> order of arguments - the first element is a Stan distribution, second is the class (b, Intercept, sd), third is coef, etc.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Error-handling">Error handling<a class="anchor-link" href="#Error-handling">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Error handling happens at the <code>rpy2</code> level, which catches the (R) error and displays it as a python <code>RRuntimeError</code> exception:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pybrms</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="s2">&quot;count_typo ~ zAge + zBase * Trt + (1|patient) + (1|obs)&quot;</span><span class="p">,</span>
                                           <span class="n">data</span> <span class="o">=</span> <span class="n">epilepsy</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="s2">&quot;poisson&quot;</span><span class="p">,</span>
                                           <span class="n">priors</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;student_t(5,0,10)&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span>
                                                     <span class="p">(</span><span class="s2">&quot;cauchy(0,2)&quot;</span><span class="p">,</span> <span class="s2">&quot;sd&quot;</span><span class="p">)]</span>
                                          <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:rpy2.rinterface_lib.callbacks:R[write to console]: Error: The following variables are missing in &#39;data&#39;:
&#39;count_typo&#39;

</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RRuntimeError</span>                             Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-6-3103bec4b060&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span>                                            data <span class="ansi-blue-fg">=</span> epilepsy<span class="ansi-blue-fg">,</span> family <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#34;poisson&#34;</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>                                            priors = [(&#34;student_t(5,0,10)&#34;, &#34;b&#34;),
<span class="ansi-green-fg">----&gt; 4</span><span class="ansi-red-fg">                                                      (&#34;cauchy(0,2)&#34;, &#34;sd&#34;)]
</span><span class="ansi-green-intense-fg ansi-bold">      5</span>                                           )

<span class="ansi-green-fg">~/projects/pybrms/pybrms/pybrms.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(formula, data, priors, family, sample_prior, sample, **pystan_args)</span>
<span class="ansi-green-intense-fg ansi-bold">    126</span>         family<span class="ansi-blue-fg">=</span>family<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    127</span>         priors<span class="ansi-blue-fg">=</span>brms_prior<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">--&gt; 128</span><span class="ansi-red-fg">         </span>sample_prior<span class="ansi-blue-fg">=</span>sample_prior<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    129</span>     )
<span class="ansi-green-intense-fg ansi-bold">    130</span>     model_data <span class="ansi-blue-fg">=</span> _convert_R_to_python<span class="ansi-blue-fg">(</span>formula<span class="ansi-blue-fg">,</span> data<span class="ansi-blue-fg">,</span> family<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/projects/pybrms/pybrms/pybrms.py</span> in <span class="ansi-cyan-fg">get_stan_code</span><span class="ansi-blue-fg">(formula, data, priors, family, sample_prior)</span>
<span class="ansi-green-intense-fg ansi-bold">     52</span>     <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>priors<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     53</span>         return brms.make_stancode(
<span class="ansi-green-fg">---&gt; 54</span><span class="ansi-red-fg">             </span>formula<span class="ansi-blue-fg">=</span>formula<span class="ansi-blue-fg">,</span> data<span class="ansi-blue-fg">=</span>data<span class="ansi-blue-fg">,</span> prior<span class="ansi-blue-fg">=</span>priors<span class="ansi-blue-fg">,</span> family<span class="ansi-blue-fg">=</span>family<span class="ansi-blue-fg">,</span> sample_prior<span class="ansi-blue-fg">=</span>sample_prior
<span class="ansi-green-intense-fg ansi-bold">     55</span>         )[0]
<span class="ansi-green-intense-fg ansi-bold">     56</span>     <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/miniconda3/envs/rpy/lib/python3.6/site-packages/rpy2/robjects/functions.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    190</span>                 kwargs<span class="ansi-blue-fg">[</span>r_k<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> v
<span class="ansi-green-intense-fg ansi-bold">    191</span>         return (super(SignatureTranslatedFunction, self)
<span class="ansi-green-fg">--&gt; 192</span><span class="ansi-red-fg">                 .__call__(*args, **kwargs))
</span><span class="ansi-green-intense-fg ansi-bold">    193</span> 
<span class="ansi-green-intense-fg ansi-bold">    194</span> 

<span class="ansi-green-fg">~/miniconda3/envs/rpy/lib/python3.6/site-packages/rpy2/robjects/functions.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    119</span>             <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    120</span>                 new_kwargs<span class="ansi-blue-fg">[</span>k<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> conversion<span class="ansi-blue-fg">.</span>py2rpy<span class="ansi-blue-fg">(</span>v<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 121</span><span class="ansi-red-fg">         </span>res <span class="ansi-blue-fg">=</span> super<span class="ansi-blue-fg">(</span>Function<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__call__<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>new_args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>new_kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    122</span>         res <span class="ansi-blue-fg">=</span> conversion<span class="ansi-blue-fg">.</span>rpy2py<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    123</span>         <span class="ansi-green-fg">return</span> res

<span class="ansi-green-fg">~/miniconda3/envs/rpy/lib/python3.6/site-packages/rpy2/rinterface_lib/conversion.py</span> in <span class="ansi-cyan-fg">_</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">     26</span> <span class="ansi-green-fg">def</span> _cdata_res_to_rinterface<span class="ansi-blue-fg">(</span>function<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     27</span>     <span class="ansi-green-fg">def</span> _<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 28</span><span class="ansi-red-fg">         </span>cdata <span class="ansi-blue-fg">=</span> function<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span>         <span class="ansi-red-fg"># TODO: test cdata is of the expected CType</span>
<span class="ansi-green-intense-fg ansi-bold">     30</span>         <span class="ansi-green-fg">return</span> _cdata_to_rinterface<span class="ansi-blue-fg">(</span>cdata<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/envs/rpy/lib/python3.6/site-packages/rpy2/rinterface.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    783</span>                     error_occured))
<span class="ansi-green-intense-fg ansi-bold">    784</span>             <span class="ansi-green-fg">if</span> error_occured<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 785</span><span class="ansi-red-fg">                 </span><span class="ansi-green-fg">raise</span> embedded<span class="ansi-blue-fg">.</span>RRuntimeError<span class="ansi-blue-fg">(</span>_rinterface<span class="ansi-blue-fg">.</span>_geterrmessage<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    786</span>         <span class="ansi-green-fg">return</span> res
<span class="ansi-green-intense-fg ansi-bold">    787</span> 

<span class="ansi-red-fg">RRuntimeError</span>: Error: The following variables are missing in &#39;data&#39;:
&#39;count_typo&#39;
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This makes sure you can debug your data/formula/etc without actually leaving python.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Visualization">Visualization<a class="anchor-link" href="#Visualization">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since <a href="/pybrms.html"><code>pybrms</code></a> returns a <code>pystan</code> object, we can easily visualize the results using <code>arviz</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="n">inference_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span><span class="n">inference_data</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">]);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include image.html file="imgs/az_post.png" %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For a more detailed walkthrough, see the accompanying <a href="link">blog post</a>.</p>

</div>
</div>
</div>
</div>
 

